<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Threat Actor Tracker</title>
    <style>
      body { margin: 0; font-family: Arial, sans-serif; background: #f7f7f7; color: #111; line-height: 1.4; }
      .layout { display: grid; grid-template-columns: 320px 1fr; min-height: 100vh; }
      .sidebar { background: #1e2430; color: #fff; padding: 16px; }
      .sidebar h1 { font-size: 20px; margin: 0 0 12px; }
      .sidebar h3 { margin-top: 18px; }
      .actor-list { list-style: none; padding: 0; margin: 0 0 16px; }
      .actor-list li { margin-bottom: 8px; }
      .actor-link { display: block; padding: 10px; border-radius: 8px; color: #fff; text-decoration: none; background: #2b3445; }
      .actor-link.selected { background: #3f5f9a; }
      .actor-name { font-weight: bold; display: block; }
      .actor-scope { font-size: 12px; opacity: 0.9; margin-top: 4px; }
      .actor-row { display: flex; gap: 8px; align-items: center; }
      .actor-row form { margin: 0; display: inline; }
      .actor-row button { padding: 6px 8px; border-radius: 6px; border: 0; background: #50627f; color: #fff; cursor: pointer; }
      .sidebar form { display: grid; gap: 8px; }
      .sidebar input, .sidebar textarea, .sidebar button { padding: 8px; border-radius: 6px; border: 1px solid #6c7586; }
      .sidebar button { background: #4a7bd0; color: #fff; border: 0; cursor: pointer; }
      .sidebar .action-button {
        display: block;
        width: 100%;
        min-height: 34px;
        padding: 8px;
        border-radius: 6px;
        box-sizing: border-box;
        border: 0;
        background: #4a7bd0;
        color: #fff;
        font-size: 14px;
        line-height: 1.2;
        font-weight: 400;
        text-align: center;
      }
      .main { padding: 16px; }
      .dashboard { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; align-items: start; }
      .card { background: #fff; border: 1px solid #d9e2ef; border-radius: 10px; padding: 14px; margin-bottom: 0; box-shadow: 0 1px 0 rgba(15, 23, 42, 0.03); }
      .card.span-2 { grid-column: 1 / -1; }
      .section-title { margin-top: 0; margin-bottom: 10px; font-size: 18px; line-height: 1.25; padding-bottom: 6px; border-bottom: 1px solid #e8eef8; }
      .section-body { padding-right: 2px; }
      .section-body p { margin: 0 0 10px; }
      .section-body ul { margin-top: 6px; }
      .event { border-left: 3px solid #3f5f9a; margin: 6px 0; padding: 6px 8px; background: #f8fbff; }
      .timeline-graphic { position: relative; margin: 10px 0 0 6px; padding-left: 28px; }
      .timeline-graphic::before { content: ""; position: absolute; left: 9px; top: 0; bottom: 0; width: 3px; background: #c7d7ef; }
      .timeline-node { position: relative; margin: 0 0 14px; padding: 10px; border: 1px solid #d8e1ef; border-radius: 8px; background: #f9fbff; }
      .timeline-node::before { content: ""; position: absolute; left: -24px; top: 14px; width: 12px; height: 12px; border-radius: 50%; background: #3f5f9a; }
      .timeline-row { display: grid; grid-template-columns: 150px 1fr; gap: 10px; align-items: start; margin-bottom: 10px; }
      .timeline-date { font-size: 12px; color: #334155; }
      .timeline-bar { height: 8px; border-radius: 999px; background: linear-gradient(90deg, #4a7bd0, #9bb7e8); margin: 6px 0 10px; }
      .timeline-meta { font-size: 12px; color: #334155; margin-top: 4px; }
      .timeline-ataglance { display: grid; grid-template-columns: 1fr 2fr; gap: 10px; align-items: start; margin-bottom: 10px; }
      .deviation-strip { border: 1px solid #dce7f8; border-radius: 8px; background: #f7fbff; padding: 8px; }
      .deviation-strip h4 { margin: 0 0 6px; font-size: 13px; }
      .chip-line { display: flex; flex-wrap: wrap; gap: 6px; }
      .chip { display: inline-block; font-size: 11px; border-radius: 999px; border: 1px solid #9db2d3; padding: 2px 8px; background: #eef4ff; }
      .chip.alert { border-color: #e4b26b; background: #fff6e7; }
      .mini-graph { border: 1px solid #dce7f8; border-radius: 8px; padding: 8px; background: #fbfdff; }
      .mini-graph h4 { margin: 0 0 6px; font-size: 13px; }
      .graph-cols { display: flex; align-items: flex-end; gap: 6px; min-height: 110px; }
      .graph-col { width: 28px; display: flex; flex-direction: column; align-items: center; gap: 4px; }
      .stack { width: 20px; height: 100px; border-radius: 6px; border: 1px solid #d8e1ef; display: flex; flex-direction: column-reverse; overflow: hidden; background: #f1f4fa; }
      .stack-seg { width: 100%; }
      .graph-label { font-size: 10px; color: #4a5568; }
      .graph-legend { display: flex; flex-wrap: wrap; gap: 6px 10px; margin-top: 8px; font-size: 11px; color: #334155; }
      .legend-item { display: inline-flex; align-items: center; gap: 5px; }
      .legend-swatch { width: 10px; height: 10px; border-radius: 2px; border: 1px solid #c9d3e5; }
      .timeline-footer-link { margin-top: 8px; font-size: 12px; }
      .priority-strip { background: #fff; border: 1px solid #dfe6f3; border-radius: 10px; padding: 10px; margin-bottom: 10px; }
      .decision-queue { margin-bottom: 0; }
      .decision-header { display: flex; justify-content: space-between; align-items: center; gap: 8px; margin-bottom: 8px; }
      .phase-block { margin-bottom: 8px; }
      .phase-title { font-size: 11px; text-transform: uppercase; letter-spacing: .02em; color: #475569; margin: 0 0 4px; }
      .dq-card { border: 1px solid #e3e9f5; border-radius: 8px; padding: 7px 8px; background: #fbfdff; margin-bottom: 6px; }
      .dq-line { font-size: 12px; line-height: 1.35; color: #1f2937; margin: 4px 0; }
      .dq-line strong { font-weight: 600; }
      .dq-list { display: grid; gap: 6px; }
      .dq-row { border: 1px solid #e3e9f5; border-radius: 8px; background: #fbfdff; }
      .dq-row > summary { cursor: pointer; padding: 7px 8px; font-size: 12px; list-style: none; }
      .dq-row > summary::-webkit-details-marker { display: none; }
      .dq-detail { padding: 0 8px 8px; }
      .deemphasized { opacity: 0.75; }
      .summary-list { margin: 8px 0 0; padding-left: 18px; }
      .summary-list li { margin: 6px 0; font-size: 13px; line-height: 1.35; }
      .snapshot-grid { display: grid; grid-template-columns: repeat(3, minmax(180px, 1fr)); gap: 8px; margin: 10px 0; }
      .snapshot-card { border: 1px solid #dfe6f3; border-radius: 8px; padding: 8px; background: #fbfdff; }
      .snapshot-title { font-size: 12px; text-transform: uppercase; letter-spacing: .02em; color: #475569; margin: 0 0 4px; }
      .snapshot-text { font-size: 13px; line-height: 1.3; margin: 0 0 6px; }
      .snapshot-meta { font-size: 11px; color: #475569; }
      .helper-box { border: 1px solid #d9e3f7; border-radius: 8px; background: #f5f8ff; padding: 8px; margin: 8px 0; }
      .helper-box h4 { margin: 0 0 6px; font-size: 13px; }
      .helper-box p { margin: 0 0 6px; font-size: 12px; line-height: 1.35; color: #1f2937; }
      .helper-box ul { margin: 6px 0 0; padding-left: 18px; }
      .helper-box li { margin: 3px 0; font-size: 12px; line-height: 1.35; }
      .inline-note { margin: 6px 0 0; font-size: 12px; color: #334155; }
      .kpi-strip { display: grid; grid-template-columns: repeat(4, minmax(120px, 1fr)); gap: 8px; margin-bottom: 10px; }
      .kpi-card { background: #fff; border: 1px solid #dfe6f3; border-radius: 10px; padding: 8px 10px; }
      .kpi-label { font-size: 11px; color: #475569; text-transform: uppercase; letter-spacing: .02em; }
      .kpi-value { font-size: 18px; font-weight: 700; margin-top: 2px; }
      .priority-list { display: grid; gap: 6px; }
      .priority-item { display: grid; grid-template-columns: 70px 1fr; gap: 8px; align-items: start; border: 1px solid #edf1f7; border-radius: 8px; padding: 6px 8px; background: #fbfdff; }
      .priority-body { display: grid; gap: 4px; }
      .priority-q { font-size: 13px; line-height: 1.3; }
      .priority-meta { font-size: 11px; color: #475569; line-height: 1.25; }
      .pbadge { display: inline-block; border-radius: 999px; padding: 2px 8px; border: 1px solid #aeb8c5; font-size: 11px; }
      .pbadge.high { background: #ffe9e8; border-color: #e5a7a4; }
      .pbadge.medium { background: #fff6df; border-color: #e6cb86; }
      .pbadge.low { background: #edf7ed; border-color: #a8d0aa; }
      .badge { display: inline-block; padding: 2px 8px; border-radius: 999px; font-size: 12px; border: 1px solid #888; }
      .badge.open { background: #fff7d8; }
      .badge.resolved { background: #e1f5e6; }
      .badge.freshness-new { background: #eaf9ef; border-color: #9fd2ac; }
      .badge.freshness-recent { background: #eef6ff; border-color: #a7c2ea; }
      .badge.freshness-stale { background: #fff6e8; border-color: #e8c885; }
      .badge.freshness-old { background: #f4f5f7; border-color: #c8ced8; }
      .badge.freshness-unknown { background: #f4f5f7; border-color: #c8ced8; }
      .source-item { border-bottom: 1px solid #e3e3e3; padding: 8px 0; }
      .recent-source-list { margin: 6px 0 0; padding: 0; list-style: none; display: grid; gap: 8px; }
      .recent-source-list li { margin: 0; font-size: 13px; border: 1px solid #e4ebf7; border-radius: 8px; background: #fbfdff; padding: 8px; }
      .source-headline { display: flex; flex-wrap: wrap; align-items: center; gap: 6px; margin-bottom: 4px; }
      .source-meta { display: block; color: #475569; font-size: 11px; line-height: 1.35; margin-bottom: 2px; }
      .source-note-toggle { margin-top: 6px; }
      .source-title-link {
        display: inline-block;
        max-width: 56ch;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        vertical-align: bottom;
      }
      .question { border: 1px solid #ddd; border-radius: 8px; padding: 8px; margin: 8px 0; }
      blockquote { margin: 6px 0; padding: 8px 10px; background: #f3f5f7; border-left: 3px solid #9aa5b1; }
      .guidance { border: 1px solid #d6e3f5; border-radius: 8px; background: #f5faff; padding: 10px; margin: 8px 0; }
      .notice { background: #fff6d9; border: 1px solid #e1cc78; border-radius: 8px; padding: 6px 8px; margin-bottom: 8px; }
      .top-status-row { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; margin-bottom: 10px; }
      .status-chip { margin-bottom: 0; padding: 4px 8px; font-size: 11px; line-height: 1.25; width: fit-content; max-width: 340px; border-radius: 999px; }
      .status-chip strong { font-weight: 600; }
      .status-meta { margin-top: 3px; font-size: 10px; color: #334155; }
      .status-running { background: #eef6ff; border-color: #a7c2ea; }
      .status-ready { background: #eaf9ef; border-color: #9fd2ac; }
      .status-error { background: #ffeceb; border-color: #e4a8a3; }
      .status-idle { background: #f4f5f7; border-color: #c8ced8; }
      .status-warning { background: #fff6e8; border-color: #e8c885; }
      .status-llm-ok { background: #eaf9ef; border-color: #9fd2ac; }
      .status-llm-bad { background: #ffeceb; border-color: #e4a8a3; }
      .status-working { background: #eef6ff; border-color: #8fb2e8; }
      .progress-wrap { margin-top: 4px; background: #dfe9f7; border-radius: 999px; height: 6px; overflow: hidden; width: 120px; }
      .progress-bar { height: 6px; width: 35%; background: #4a7bd0; border-radius: 999px; animation: loading 1.1s linear infinite; }
      @keyframes loading { 0% { margin-left: -35%; } 100% { margin-left: 100%; } }
      .empty { padding: 40px; text-align: center; background: #fff; border: 1px dashed #bbb; border-radius: 8px; }
      pre { white-space: pre-wrap; margin: 0; }
      .track-grid { display: grid; gap: 8px; }
      .track-row { display: flex; justify-content: space-between; align-items: center; border: 1px solid #ddd; border-radius: 8px; padding: 8px; }
      .mini-form { display: inline; }
      .mini-form button { padding: 6px 10px; }
      details.compact { border: 1px solid #e3e3e3; border-radius: 8px; padding: 8px 10px; margin-top: 8px; background: #fafafa; }
      details.compact > summary { cursor: pointer; font-weight: 600; }
      .sidebar-card { margin-top: 14px; padding-top: 12px; border-top: 1px solid #3d4658; }
      .sidebar-card h3 { margin: 0 0 8px; }
      .sidebar-card small { display: block; opacity: 0.9; margin-bottom: 8px; line-height: 1.35; }
      .sidebar details.compact { background: #2b3445; border: 1px solid #3d4658; color: #fff; }
      .sidebar details.compact > summary { list-style: none; }
      .sidebar details.compact > summary::-webkit-details-marker { display: none; }
      .sidebar .secondary-action {
        margin-top: 8px;
        padding: 0;
        border: 0;
        background: transparent;
      }
      .sidebar .secondary-action > summary {
        cursor: pointer;
      }
      .sidebar .secondary-action[open] {
        padding: 8px;
        border: 1px solid #3d4658;
        border-radius: 8px;
        background: #2b3445;
      }
      .sidebar .secondary-action[open] > summary { margin-bottom: 8px; }
      .req-item { border: 1px solid #e3e3e3; border-radius: 8px; padding: 8px; margin-bottom: 8px; background: #fcfcff; }
      .req-item p { margin: 6px 0; font-size: 13px; line-height: 1.35; }
      .req-item form { margin-top: 6px; }
      .req-validation { margin-top: 6px; font-size: 11px; color: #334155; background: #f5f8ff; border: 1px solid #d9e3f7; border-radius: 6px; padding: 6px; }
      .flow-nav { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 10px; }
      .flow-btn { border: 1px solid #c7d4ea; background: #fff; color: #1f2937; border-radius: 999px; padding: 6px 10px; font-size: 12px; cursor: pointer; }
      .flow-btn.active { background: #e7f0ff; border-color: #86a8da; }
      .flow-btn:hover { background: #f3f7ff; }
      .flow-help { font-size: 11px; color: #475569; margin-top: -2px; margin-bottom: 8px; }
      .focus-who [data-step]:not([data-step="who"]),
      .focus-recent [data-step]:not([data-step="recent"]),
      .focus-action [data-step]:not([data-step="action"]) { opacity: 0.5; }
      .live-pill { border: 1px solid #c7d4ea; border-radius: 999px; padding: 4px 8px; font-size: 11px; color: #334155; background: #f8fbff; }
      .interactive-panel { border: 1px solid #dce7f8; border-radius: 8px; background: #f9fcff; padding: 8px; margin-top: 8px; }
      .interactive-panel h4 { margin: 0 0 6px; font-size: 13px; }
      .filter-row { display: flex; flex-wrap: wrap; gap: 8px; align-items: center; margin-bottom: 8px; }
      .filter-row select, .filter-row button, .filter-row input { padding: 5px 8px; border-radius: 6px; border: 1px solid #c7d4ea; background: #fff; font-size: 12px; }
      .timeline-table { width: 100%; border-collapse: collapse; font-size: 12px; }
      .timeline-table th, .timeline-table td { border-bottom: 1px solid #e3ebf8; text-align: left; padding: 6px; vertical-align: top; }
      .timeline-table tr:hover { background: #f3f8ff; }
      .timeline-empty { margin-top: 8px; font-size: 12px; color: #475569; }
      .observation-meta { margin-top: 4px; font-size: 11px; color: #475569; }
      .obs-row { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 8px; }
      .obs-row input, .obs-row select, .obs-row textarea { width: 100%; box-sizing: border-box; padding: 6px; border-radius: 6px; border: 1px solid #cdd8ea; font-size: 12px; }
      .obs-row textarea { min-height: 70px; resize: vertical; grid-column: 1 / -1; }
      .obs-actions { display: flex; gap: 6px; align-items: center; margin-top: 6px; }
      .obs-actions button { border: 1px solid #b8c7e2; background: #f7fbff; border-radius: 6px; padding: 5px 8px; font-size: 12px; cursor: pointer; }
      .ledger-list { display: grid; gap: 8px; margin-top: 8px; }
      .ledger-item { border: 1px solid #dce7f8; border-radius: 8px; background: #fbfdff; padding: 8px; }
      .ledger-head { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; margin-bottom: 4px; font-size: 11px; color: #475569; }
      .ledger-body { font-size: 13px; line-height: 1.35; color: #1f2937; margin-bottom: 4px; }
      .ledger-link { font-size: 12px; }
      .ledger-controls { display: grid; grid-template-columns: repeat(5, minmax(120px, 1fr)); gap: 8px; align-items: end; margin-top: 8px; }
      .ledger-controls label { display: block; font-size: 11px; color: #334155; margin-bottom: 3px; }
      .ledger-controls input, .ledger-controls select { width: 100%; box-sizing: border-box; padding: 6px; border: 1px solid #cdd8ea; border-radius: 6px; background: #fff; font-size: 12px; }
      .ledger-actions { display: flex; gap: 6px; align-items: center; flex-wrap: wrap; margin-top: 8px; }
      .ledger-actions button, .ledger-actions a { border: 1px solid #b8c7e2; background: #f7fbff; border-radius: 6px; padding: 5px 8px; font-size: 12px; cursor: pointer; text-decoration: none; color: #1f2937; }
      .ledger-count { font-size: 11px; color: #475569; }
      .live-controls { display: inline-flex; gap: 6px; align-items: center; }
      .live-controls button { border: 1px solid #c7d4ea; background: #fff; border-radius: 999px; font-size: 11px; padding: 4px 8px; cursor: pointer; }
      @media (max-width: 1180px) { .dashboard { grid-template-columns: 1fr; } .card.span-2 { grid-column: auto; } .timeline-ataglance { grid-template-columns: 1fr; } .kpi-strip { grid-template-columns: repeat(2, minmax(120px, 1fr)); } .snapshot-grid { grid-template-columns: 1fr; } }
      @media (max-width: 960px) { .layout { grid-template-columns: 1fr; } .status-chip { max-width: 100%; width: 100%; } .obs-row { grid-template-columns: 1fr; } .ledger-controls { grid-template-columns: 1fr 1fr; } }
    </style>
  </head>
  <body {% if notebook %}data-actor-id="{{ notebook.actor.id }}"{% endif %}>
    <div class="layout">
      <aside class="sidebar">
        <h1>Threat Actor Tracker</h1>
        <h3>Tracked actors</h3>
        <ul class="actor-list">
          {% for actor in actors %}
          <li>
            <div class="actor-row">
              <a class="actor-link {% if selected_actor_id == actor.id %}selected{% endif %}" href="/?actor_id={{ actor.id }}">
                <span class="actor-name">{{ actor.display_name }}</span>
                <span class="actor-scope">Updated {{ actor.last_updated_label or 'Unknown' }}</span>
              </a>
              <form method="post" action="/actors/{{ actor.id }}/untrack">
                <button type="submit">Untrack</button>
              </form>
            </div>
          </li>
          {% else %}
          <li><span class="actor-scope">No tracked actors yet.</span></li>
          {% endfor %}
        </ul>

        <h3>Add actor</h3>
        <form method="post" action="/actors/new">
          <input type="text" name="display_name" placeholder="Display name" required />
          <button class="action-button" type="submit">Add actor</button>
        </form>

        {% if notebook %}
        <div class="sidebar-card">
          <h3>Data Operations</h3>
          <small>Use these controls to update evidence and generate requirements without interrupting review.</small>
          <details class="compact secondary-action">
            <summary class="action-button">Open data operations</summary>
            <form method="post" action="/actors/{{ notebook.actor.id }}/requirements/generate">
              <label for="priority_mode">Priority Mode</label>
              <select id="priority_mode" name="priority_mode">
                <option value="Strategic" {% if notebook.requirements_context.priority_mode == 'Strategic' %}selected{% endif %}>Strategic (PIR)</option>
                <option value="Operational" {% if notebook.requirements_context.priority_mode == 'Operational' %}selected{% endif %}>Operational (GIR)</option>
                <option value="Tactical" {% if notebook.requirements_context.priority_mode == 'Tactical' %}selected{% endif %}>Tactical (IR)</option>
              </select>
              <label for="org_context">Org Context</label>
              <textarea id="org_context" name="org_context" rows="4" placeholder="Critical assets, business unit, environment, constraints...">{{ notebook.requirements_context.org_context }}</textarea>
              <button class="action-button" type="submit">Generate PIR/GIR/IR</button>
            </form>
            <form method="post" action="/actors/{{ notebook.actor.id }}/sources">
              <input type="url" name="source_url" placeholder="https://..." required />
              <button type="submit">Fetch and add source</button>
            </form>
            <form method="post" action="/actors/{{ notebook.actor.id }}/sources/import-feeds">
              <button type="submit">Import established CTI RSS sources</button>
            </form>
            <form method="post" action="/actors/{{ notebook.actor.id }}/refresh">
              <button type="submit">Refresh notebook</button>
            </form>
            <form method="post" action="/actors/{{ notebook.actor.id }}/iocs">
              <select name="ioc_type">
                <option value="ip">IP</option>
                <option value="domain">Domain</option>
                <option value="hash">Hash</option>
                <option value="url">URL</option>
                <option value="email">Email</option>
                <option value="indicator" selected>Indicator</option>
              </select>
              <input type="text" name="source_ref" placeholder="Source reference (optional)" />
              <textarea name="ioc_values" rows="4" placeholder="One IOC per line or comma-separated" required></textarea>
              <button type="submit">Save IOCs</button>
            </form>
          </details>
          {% if notebook.requirements %}
          <details class="compact">
            <summary>Latest Requirements ({{ notebook.requirements | length }})</summary>
            {% for req in notebook.requirements[:6] %}
            <div class="req-item">
              <div><span class="badge">{{ req.req_type }}</span> <span class="badge {% if req.status == 'open' %}open{% else %}resolved{% endif %}">{{ req.status }}</span></div>
              <p><strong>{{ req.requirement_text }}</strong></p>
              <div class="req-validation">
                <strong>Validation:</strong> {{ req.validation_score }}/10<br />
                <strong>Checks:</strong> {{ req.validation_notes or 'passed' }}
              </div>
              {% if req.source_url %}
              <p><small><a href="{{ req.source_url }}" target="_blank" rel="noreferrer">{{ req.source_name or req.source_url }}</a></small></p>
              {% endif %}
              {% if req.status == 'open' %}
              <form method="post" action="/requirements/{{ req.id }}/resolve">
                <input type="hidden" name="actor_id" value="{{ notebook.actor.id }}" />
                <button type="submit">Resolve</button>
              </form>
              {% endif %}
            </div>
            {% endfor %}
          </details>
          {% endif %}
        </div>
        {% endif %}
      </aside>

      <main class="main">
        <div class="top-status-row">
          <div class="notice status-chip status-{{ notebook_health.state }}">
            <strong>Notebook health:</strong> {{ notebook_health.message }}
            <div class="status-meta">Last refresh: {{ notebook_health.last_refresh_duration }} | Sources processed: {{ notebook_health.last_refresh_sources }}</div>
            {% if notebook and notebook.actor.notebook_status == 'running' %}
            <div class="progress-wrap"><div class="progress-bar"></div></div>
            {% endif %}
          </div>
          {% if notice %}
          <div class="notice status-chip">{{ notice }}</div>
          {% endif %}
          {% if notebook %}
          <div class="live-controls">
            <span class="live-pill" id="live-indicator">Live sync on</span>
            <button type="button" id="live-toggle">Pause</button>
            <button type="button" id="live-refresh">Refresh now</button>
          </div>
          {% endif %}
        </div>
        {% if not notebook %}
        <div class="empty">Select an actor to open the notebook.</div>
        {% else %}
        <div class="dashboard">
        <section class="card span-2">
          <h2 class="section-title">Start Here (for new analysts)</h2>
          <div class="helper-box">
            <h4>How to use this page in order</h4>
            <ul>
              <li><strong>Step 1 - Who are they?</strong> Learn the actor profile and common techniques.</li>
              <li><strong>Step 2 - What changed recently?</strong> Review the snapshot cards to understand impact fast.</li>
              <li><strong>Step 3 - How is the assessment changing?</strong> Capture observations tied to source evidence over time.</li>
            </ul>
          </div>
          <div class="flow-nav" id="flow-nav">
            <button class="flow-btn active" type="button" data-flow="all">Full flow</button>
            <button class="flow-btn" type="button" data-flow="who">Focus: Who</button>
            <button class="flow-btn" type="button" data-flow="recent">Focus: Recent</button>
            <button class="flow-btn" type="button" data-flow="action">Focus: Action</button>
          </div>
          <div class="flow-help">Focus mode only dims non-selected sections; nothing is hidden or blocked.</div>
          <details class="compact">
            <summary>Quick definitions (optional)</summary>
            <div class="helper-box">
              <p><strong>Technique ID:</strong> A MITRE ATT&CK behavior label (example: <code>T1486</code>) used to map activity patterns.</p>
              <p><strong>Confidence:</strong> How strong the evidence is based on source count and recency.</p>
              <p><strong>Source reliability + information credibility:</strong> Use A-F and 1-6 to standardize historical source quality.</p>
            </div>
          </details>
        </section>

        <section class="card" data-step="who">
          <h2 class="section-title">1) Who are they?</h2>
          <div class="section-body">
          <p>{{ notebook.actor_profile_summary }}</p>
          <p><small>Framework Group Match: {{ notebook.actor_profile_group_name }}</small></p>
          <p><small>Source: <a href="{{ notebook.actor_profile_source_url }}" target="_blank" rel="noreferrer">{{ notebook.actor_profile_source_label }}</a></small></p>
          <p><strong>Common moves they use (top 3)</strong></p>
          {% if notebook.top_techniques %}
          <ul>
            {% for technique in notebook.top_techniques[:3] %}
            <li>
              {% if technique.technique_url %}
              <a href="{{ technique.technique_url }}" target="_blank" rel="noreferrer">
                {{ technique.technique_id or 'Technique' }}
              </a>
              {% else %}
              {{ technique.technique_id or 'Technique' }}
              {% endif %}
              - {{ technique.technique_name }}
              {% if technique.phase %}
              <small>({{ technique.phase.replace('_', ' ') }})</small>
              {% endif %}
            </li>
            {% endfor %}
          </ul>
          <p><small>New to ATT&CK IDs? Treat these as behavior tags to guide detections and hunts.</small></p>
          {% else %}
          <p><small>No mapped technique profile available yet.</small></p>
          {% endif %}
          <ul class="summary-list">
            <li><strong>Recent activity count:</strong> {{ notebook.kpis.activity_30d }}</li>
            <li><strong>New techniques count:</strong> {{ notebook.kpis.new_techniques_30d }}</li>
            <li><strong>Last checked:</strong> {{ notebook.kpis.last_verified_update }}</li>
          </ul>
          <p><strong>Emerging techniques observed</strong></p>
          {% if notebook.emerging_techniques %}
          <ul class="summary-list">
            {% for technique in notebook.emerging_techniques[:3] %}
            <li>
              {% if technique.technique_url %}
              <a href="{{ technique.technique_url }}" target="_blank" rel="noreferrer">{{ technique.technique_id }}</a>
              {% else %}
              {{ technique.technique_id }}
              {% endif %}
              {% if technique.technique_name %} - {{ technique.technique_name }}{% endif %}
              <small>(first seen {{ technique.first_seen or 'unknown' }}, {{ technique.source_count }} sources, {{ technique.event_count }} events)</small>
            </li>
            {% endfor %}
          </ul>
          {% else %}
          <p><small>No new technique IDs observed yet in actor-specific recent reporting.</small></p>
          {% endif %}
          <p><small>Created: {{ notebook.actor_created_date }}</small></p>
          </div>
          {% if not notebook.actor.is_tracked %}
          <form method="post" action="/actors/{{ notebook.actor.id }}/track">
            <button type="submit">Track actor</button>
          </form>
          {% endif %}
        </section>

        <section class="card" data-step="recent">
          <h2 class="section-title">2) What have they been up to recently?</h2>
          {% if notebook.actor.notebook_status == 'running' %}
          <div class="notice status-working">Source collection is running in the background. This section will populate automatically.</div>
          {% endif %}
          <div class="section-body">
          {% set recent_change = notebook.get('recent_change_summary', {'new_reports': '0', 'targets': 'Not clear yet', 'damage': 'No clear damage outcome reported yet'}) %}
          <p><strong>Recent activity snapshot:</strong></p>
          <ul class="summary-list">
            <li><strong>Report count:</strong> <span id="recent-reports">{{ recent_change.new_reports }}</span></li>
            <li><strong>Target sectors:</strong> <span id="recent-targets">{{ recent_change.targets }}</span></li>
            <li><strong>Reported impact:</strong> <span id="recent-impact">{{ recent_change.damage }}</span></li>
          </ul>
          {% if notebook.recent_activity_synthesis %}
          <p class="inline-note"><strong>How to read:</strong> left to right = change, affected area, and recommended first action.</p>
          <div class="snapshot-grid">
            {% for synthesis in notebook.recent_activity_synthesis %}
            <div class="snapshot-card">
              <h3 class="snapshot-title">{{ synthesis.label }}</h3>
              <p class="snapshot-text">{{ synthesis.text }}</p>
              <div class="snapshot-meta">
                <span class="badge">{{ synthesis.confidence }}</span>
                <span>{{ synthesis.lineage }}</span>
              </div>
            </div>
            {% endfor %}
          </div>
          {% endif %}
          {% if notebook.recent_activity_highlights %}
          {% set corroborating = notebook.recent_activity_highlights[0] %}
          <div class="event">
            <strong>Best corroborating evidence right now:</strong>
            {% if corroborating.source_url %}
            <a href="{{ corroborating.source_url }}" target="_blank" rel="noreferrer">{{ corroborating.evidence_title or 'Source article' }}</a>
            {% else %}
            <span>{{ corroborating.evidence_title or 'Source article' }}</span>
            {% endif %}
            <small>{{ corroborating.date }} | {{ corroborating.evidence_source_label or corroborating.source_name or 'Unknown source' }}</small>
          </div>
          <p><strong>Latest 3 sources:</strong></p>
          {% set latest_diverse = namespace(items=[], seen_domains=[]) %}
          {% for item in notebook.recent_activity_highlights %}
          {% set domain_key = (item.evidence_group_domain or item.evidence_source_label or item.source_name or 'unknown')|lower %}
          {% if domain_key not in latest_diverse.seen_domains %}
          {% set _ = latest_diverse.items.append(item) %}
          {% set _ = latest_diverse.seen_domains.append(domain_key) %}
          {% endif %}
          {% endfor %}
          <ul class="recent-source-list">
            {% for item in latest_diverse.items[:3] %}
            {% set raw_title = (item.evidence_title or 'Untitled article') %}
            {% if raw_title.startswith('http://') or raw_title.startswith('https://') or (raw_title.count('/') >= 2 and ' ' not in raw_title) %}
            {% set display_title = 'Untitled article' %}
            {% else %}
            {% set display_title = raw_title %}
            {% endif %}
            {% set observation_key = item.source_id or item.timeline_event_id or ('highlight-' ~ loop.index0) %}
            <li>
              <div class="source-headline">
                <span class="badge">{{ item.date }}</span>
                <span class="badge {{ item.freshness_class }}">{{ item.freshness_label }}</span>
                {% if item.source_url %}
                <a class="source-title-link" href="{{ item.source_url }}" target="_blank" rel="noreferrer">{{ display_title }}</a>
                {% else %}
                <span class="source-title-link">{{ display_title }}</span>
                {% endif %}
              </div>
              <small class="source-meta">{{ item.evidence_source_label or item.source_name or 'Unknown source' }} | corroboration: {{ item.corroboration_sources or '1' }} source(s)</small>
              <details class="compact source-note-toggle">
                <summary>Analyst observation (optional)</summary>
                <div class="interactive-panel" data-observation-item-type="source" data-observation-item-key="{{ observation_key }}">
                  <p class="inline-note" style="margin:0 0 6px;"><strong>Reference format:</strong> note + confidence + source reliability (A-F) + information credibility (1-6).</p>
                  <div class="obs-row">
                    <div>
                      <label>Analyst</label>
                      <input type="text" class="observation-analyst" placeholder="name or handle" />
                    </div>
                    <div>
                      <label>Confidence</label>
                      <select class="observation-confidence">
                        <option value="moderate">Moderate</option>
                        <option value="high">High</option>
                        <option value="low">Low</option>
                      </select>
                    </div>
                    <div>
                      <label>Source reliability (A-F)</label>
                      <select class="observation-source-reliability">
                        <option value="">n/a</option>
                        <option value="A">A</option>
                        <option value="B">B</option>
                        <option value="C">C</option>
                        <option value="D">D</option>
                        <option value="E">E</option>
                        <option value="F">F</option>
                      </select>
                    </div>
                    <div>
                      <label>Info credibility (1-6)</label>
                      <select class="observation-information-credibility">
                        <option value="">n/a</option>
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="5">5</option>
                        <option value="6">6</option>
                      </select>
                    </div>
                    <div>
                      <label>Source reference (optional)</label>
                      <input type="text" class="observation-source-ref" placeholder="report id, tweet id, case link..." />
                    </div>
                    <textarea class="observation-note" placeholder="Historical context, pattern shift, or caveats..."></textarea>
                  </div>
                  <div class="obs-actions">
                    <button type="button" class="observation-save">Save observation</button>
                    <span class="observation-meta" data-observation-meta></span>
                  </div>
                </div>
              </details>
            </li>
            {% endfor %}
          </ul>
          <details class="compact">
            <summary>All sources</summary>
            <div class="event">
              <div><strong>Recent sources</strong></div>
              <ul class="recent-source-list">
                {% for item in notebook.recent_activity_highlights %}
                {% set raw_title = (item.evidence_title or 'Untitled article') %}
                {% if raw_title.startswith('http://') or raw_title.startswith('https://') or (raw_title.count('/') >= 2 and ' ' not in raw_title) %}
                {% set display_title = 'Untitled article' %}
                {% else %}
                {% set display_title = raw_title %}
                {% endif %}
                <li>
                  <div class="source-headline">
                    <span class="badge">{{ item.date }}</span>
                    <span class="badge {{ item.freshness_class }}">{{ item.freshness_label }}</span>
                    {% if item.source_url %}
                    <a class="source-title-link" href="{{ item.source_url }}" target="_blank" rel="noreferrer">{{ display_title }}</a>
                    {% else %}
                    <span class="source-title-link">{{ display_title }}</span>
                    {% endif %}
                    {% if item.category %}<span class="badge">{{ item.category }}</span>{% endif %}
                    {% if item.ttp_ids %}<span class="badge">{{ item.ttp_ids }}</span>{% endif %}
                  </div>
                  <small class="source-meta">{{ item.evidence_source_label or item.source_name or 'Unknown source' }} | corroboration: {{ item.corroboration_sources or '1' }} source(s)</small>
                  {% set all_observation_key = item.source_id or item.timeline_event_id or ('all-highlight-' ~ loop.index0) %}
                  <details class="compact source-note-toggle">
                    <summary>Analyst observation (optional)</summary>
                    <div class="interactive-panel" data-observation-item-type="source" data-observation-item-key="{{ all_observation_key }}">
                      <p class="inline-note" style="margin:0 0 6px;"><strong>Reference format:</strong> note + confidence + source reliability (A-F) + information credibility (1-6).</p>
                      <div class="obs-row">
                        <div>
                          <label>Analyst</label>
                          <input type="text" class="observation-analyst" placeholder="name or handle" />
                        </div>
                        <div>
                          <label>Confidence</label>
                          <select class="observation-confidence">
                            <option value="moderate">Moderate</option>
                            <option value="high">High</option>
                            <option value="low">Low</option>
                          </select>
                        </div>
                        <div>
                          <label>Source reliability (A-F)</label>
                          <select class="observation-source-reliability">
                            <option value="">n/a</option>
                            <option value="A">A</option>
                            <option value="B">B</option>
                            <option value="C">C</option>
                            <option value="D">D</option>
                            <option value="E">E</option>
                            <option value="F">F</option>
                          </select>
                        </div>
                        <div>
                          <label>Info credibility (1-6)</label>
                          <select class="observation-information-credibility">
                            <option value="">n/a</option>
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                            <option value="5">5</option>
                            <option value="6">6</option>
                          </select>
                        </div>
                        <div>
                          <label>Source reference (optional)</label>
                          <input type="text" class="observation-source-ref" placeholder="report id, tweet id, case link..." />
                        </div>
                        <textarea class="observation-note" placeholder="Historical context, pattern shift, or caveats..."></textarea>
                      </div>
                      <div class="obs-actions">
                        <button type="button" class="observation-save">Save observation</button>
                        <span class="observation-meta" data-observation-meta></span>
                      </div>
                    </div>
                  </details>
                </li>
                {% endfor %}
              </ul>
              <div class="timeline-footer-link"><a href="/actors/{{ notebook.actor.id }}/timeline/details">View all sources</a></div>
            </div>
          </details>
          {% else %}
          <p>No recent activity summary yet.</p>
          {% endif %}

          </div>

          {% if notebook.ioc_items %}
          <details class="compact">
            <summary>Recent IOCs</summary>
            <div class="section-body">
              {% for ioc in notebook.ioc_items[:20] %}
              <div><span class="badge">{{ ioc.ioc_type }}</span> {{ ioc.ioc_value }}{% if ioc.source_ref %} ({{ ioc.source_ref }}){% endif %}</div>
              {% endfor %}
            </div>
          </details>
          {% endif %}
          <details class="compact">
            <summary>Interactive event view (optional)</summary>
            <div class="interactive-panel">
              <h4>Filter timeline events quickly</h4>
              <div class="filter-row">
                <label for="timeline-severity">Severity</label>
                <select id="timeline-severity">
                  <option value="">All</option>
                  <option value="high">High</option>
                  <option value="medium">Medium</option>
                  <option value="low">Low</option>
                </select>
                <label for="timeline-category">Category</label>
                <select id="timeline-category">
                  <option value="">All</option>
                  {% set timeline_categories = namespace(seen=[]) %}
                  {% for item in notebook.timeline_compact_rows %}
                  {% set category_value = (item.category or '')|lower %}
                  {% if category_value and category_value not in timeline_categories.seen %}
                  {% set _ = timeline_categories.seen.append(category_value) %}
                  <option value="{{ category_value }}">{{ item.category }}</option>
                  {% endif %}
                  {% endfor %}
                </select>
                <label for="timeline-search">Contains</label>
                <input id="timeline-search" type="text" placeholder="target, technique, action..." />
                <button type="button" id="timeline-reset">Reset</button>
              </div>
              {% if notebook.timeline_compact_rows %}
              <table class="timeline-table">
                <thead>
                  <tr>
                    <th>Date</th>
                    <th>Severity</th>
                    <th>Category</th>
                    <th>Action</th>
                    <th>Target</th>
                  </tr>
                </thead>
                <tbody id="timeline-filter-body">
                  {% for item in notebook.timeline_compact_rows %}
                  <tr
                    data-severity="{{ item.severity|lower }}"
                    data-category="{{ item.category|lower }}"
                    data-search="{{ (item.action ~ ' ' ~ item.target ~ ' ' ~ item.techniques ~ ' ' ~ item.summary)|lower }}"
                  >
                    <td>{{ item.date }}</td>
                    <td><span class="badge">{{ item.severity }}</span></td>
                    <td>{{ item.category }}</td>
                    <td>{{ item.action }}</td>
                    <td>{{ item.target or 'n/a' }}</td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
              <div id="timeline-empty" class="timeline-empty" style="display:none;">No events match the current filter.</div>
              {% else %}
              <div class="timeline-empty">No compact events available yet.</div>
              {% endif %}
            </div>
          </details>
        </section>

        <section class="card span-2" data-step="action">
          <h2 class="section-title">3) Analyst Interpretation Over Time</h2>
          <p class="deemphasized" style="margin:0 0 8px;">
            Capture and review source-linked observations to track how assessment evolves over time.
          </p>
          <div class="interactive-panel">
            <h4>Observation Ledger</h4>
            <div class="ledger-controls">
              <div>
                <label for="ledger-filter-analyst">Analyst</label>
                <input id="ledger-filter-analyst" type="text" placeholder="name contains..." />
              </div>
              <div>
                <label for="ledger-filter-confidence">Confidence</label>
                <select id="ledger-filter-confidence">
                  <option value="">All</option>
                  <option value="high">High</option>
                  <option value="moderate">Moderate</option>
                  <option value="low">Low</option>
                </select>
              </div>
              <div>
                <label for="ledger-filter-from">Updated from</label>
                <input id="ledger-filter-from" type="date" />
              </div>
              <div>
                <label for="ledger-filter-to">Updated to</label>
                <input id="ledger-filter-to" type="date" />
              </div>
              <div>
                <label for="ledger-limit">Show</label>
                <select id="ledger-limit">
                  <option value="12">12</option>
                  <option value="25">25</option>
                  <option value="50">50</option>
                </select>
              </div>
            </div>
            <div class="ledger-actions">
              <button type="button" id="ledger-apply">Apply filters</button>
              <button type="button" id="ledger-clear">Clear</button>
              <a id="ledger-export-json" href="#" target="_blank" rel="noreferrer">Export JSON</a>
              <a id="ledger-export-csv" href="#" target="_blank" rel="noreferrer">Export CSV</a>
              <span id="observation-ledger-count" class="ledger-count"></span>
            </div>
            <div id="observation-ledger-empty" class="timeline-empty">No observations saved yet.</div>
            <div id="observation-ledger-list" class="ledger-list"></div>
          </div>
        </section>

        {% if notebook.priority_questions %}
        <section class="card span-2 decision-queue" data-step="action">
          <div class="decision-header">
            <h2 class="section-title" style="margin:0;">Historical Analysis Prompts (optional)</h2>
            <a href="/actors/{{ notebook.actor.id }}/questions">Open workspace</a>
          </div>
          <p class="deemphasized" style="margin:0 0 8px;">
            Use these prompts to deepen context and compare this cycle against prior reporting.
          </p>
          <details class="compact">
            <summary>How to use these prompts (optional)</summary>
            <div class="helper-box">
              <ul>
                <li>Work top-to-bottom on the first 1-3 prompts.</li>
                <li>Capture what changed from prior assessment in source-linked observations.</li>
                <li>Record uncertainty explicitly when evidence is incomplete or mixed.</li>
              </ul>
            </div>
          </details>
          <div class="dq-list">
            {% for question in notebook.priority_questions[:3] %}
            <details class="dq-row" open>
              <summary>
                <strong>{{ question.quick_check_title }}</strong>
                <span class="pbadge {{ question.priority.lower() }}">{{ question.priority }}</span>
              </summary>
              <div class="dq-detail">
                <div class="dq-line"><strong>Assessment question:</strong> {{ question.decision_trigger }}</div>
                <div class="dq-line"><strong>Starting angle:</strong> {{ question.first_step or question.telemetry_anchor }}</div>
                {% if question.query_hint %}
                <div class="dq-line"><strong>Suggested query:</strong> {{ question.query_hint }}</div>
                {% endif %}
                {% if question.what_to_look_for %}
                <div class="dq-line"><strong>Evidence to compare:</strong> {{ question.what_to_look_for }}</div>
                {% endif %}
                <div class="dq-line"><strong>Confidence threshold:</strong> {{ question.escalation_threshold }}</div>
                {% if question.success_condition %}
                <div class="dq-line"><strong>Alternative interpretation:</strong> {{ question.success_condition }}</div>
                {% endif %}
                <div class="dq-line"><strong>Evidence quality:</strong> {{ question.confidence }} | {{ question.evidence_recency }} | corroboration: {{ question.corroborating_sources }} source(s) | org fit: {{ question.org_alignment }}</div>
                {% if question.updated_at %}
                <div class="dq-line"><strong>Last signal update:</strong> {{ question.updated_at }}</div>
                {% endif %}
              </div>
            </details>
            {% endfor %}
          </div>
        </section>
        {% endif %}

        <section class="card span-2" data-step="recent">
          <h2 class="section-title">4) Visual timeline</h2>
          {% if notebook.actor.notebook_status == 'running' %}
          <div class="notice status-working">Timeline events are being generated from source evidence.</div>
          {% endif %}
          <details class="compact">
            <summary>Show timeline</summary>
          {% if notebook.timeline_recent_items %}
          <div class="timeline-ataglance">
            <div class="deviation-strip">
              <h4>Recent Deviations ({{ notebook.timeline_window_label }})</h4>
              <div class="chip-line">
                {% for dev in notebook.emerging_techniques %}
                <span class="chip alert">{{ dev.technique_id }}{% if dev.last_seen %} ({{ dev.last_seen }}){% endif %} - {{ dev.source_count }} src</span>
                {% else %}
                <span class="chip">No deviations yet</span>
                {% endfor %}
              </div>
            </div>
            <div class="mini-graph">
              <h4>Activity Over Time ({{ notebook.timeline_window_label }})</h4>
              <div class="graph-cols">
                {% for bucket in notebook.timeline_graph %}
                <div class="graph-col" title="{{ bucket.label }} ({{ bucket.total }} events)">
                  <div class="stack" style="height: {{ bucket.height_pct }}px;">
                    {% for seg in bucket.segments %}
                    <div class="stack-seg" style="background: {{ seg.color }}; flex: {{ seg.flex }};" title="{{ seg.category }}: {{ seg.count }}"></div>
                    {% endfor %}
                  </div>
                  <div class="graph-label">{{ bucket.label[5:] }}</div>
                </div>
                {% endfor %}
              </div>
              <div class="graph-legend">
                <span class="legend-item"><span class="legend-swatch" style="background:#5b8def;"></span>Initial access</span>
                <span class="legend-item"><span class="legend-swatch" style="background:#49a078;"></span>Execution</span>
                <span class="legend-item"><span class="legend-swatch" style="background:#8a6adf;"></span>Persistence</span>
                <span class="legend-item"><span class="legend-swatch" style="background:#2e8bcb;"></span>Lateral movement</span>
                <span class="legend-item"><span class="legend-swatch" style="background:#d48a2f;"></span>Command and control</span>
                <span class="legend-item"><span class="legend-swatch" style="background:#c44f4f;"></span>Exfiltration</span>
                <span class="legend-item"><span class="legend-swatch" style="background:#9f2d2d;"></span>Impact</span>
                <span class="legend-item"><span class="legend-swatch" style="background:#6f7d8c;"></span>Defense evasion</span>
                <span class="legend-item"><span class="legend-swatch" style="background:#7b8a97;"></span>Report</span>
              </div>
            </div>
          </div>
          <div class="timeline-footer-link">
            <a href="/actors/{{ notebook.actor.id }}/timeline/details">View all details</a>
          </div>
          {% else %}
          <p>No timeline entries yet.</p>
          {% endif %}
          </details>
        </section>

        </div>
        {% endif %}
      </main>
    </div>
    {% if notebook %}
    <script>
      (function () {
        const actorId = document.body.dataset.actorId || "";
        if (!actorId) return;

        const dashboard = document.querySelector(".dashboard");
        const flowButtons = document.querySelectorAll("#flow-nav .flow-btn");
        const liveIndicator = document.getElementById("live-indicator");
        const liveToggle = document.getElementById("live-toggle");
        const liveRefresh = document.getElementById("live-refresh");
        const reportNode = document.getElementById("recent-reports");
        const targetsNode = document.getElementById("recent-targets");
        const impactNode = document.getElementById("recent-impact");
        let liveEnabled = true;

        function applyFlow(mode) {
          if (!dashboard) return;
          dashboard.classList.remove("focus-who", "focus-recent", "focus-action");
          if (mode !== "all") dashboard.classList.add("focus-" + mode);
          flowButtons.forEach((btn) => btn.classList.toggle("active", btn.dataset.flow === mode));
        }

        flowButtons.forEach((btn) => {
          btn.addEventListener("click", () => applyFlow(btn.dataset.flow || "all"));
        });

        async function fetchLiveState() {
          const response = await fetch("/actors/" + encodeURIComponent(actorId) + "/ui/live", { headers: { "Accept": "application/json" } });
          if (!response.ok) return null;
          return response.json();
        }

        function applyLiveState(data) {
          if (!data) return;
          if (liveIndicator) {
            const state = String(data.notebook_status || "idle");
            liveIndicator.textContent = "Live: " + state;
          }
          const recent = data.recent_change_summary || {};
          if (reportNode && recent.new_reports !== undefined) reportNode.textContent = String(recent.new_reports);
          if (targetsNode && recent.targets !== undefined) targetsNode.textContent = String(recent.targets);
          if (impactNode && recent.damage !== undefined) impactNode.textContent = String(recent.damage);
        }

        async function runLiveRefresh() {
          try {
            const data = await fetchLiveState();
            applyLiveState(data);
          } catch (error) {
            if (liveIndicator) liveIndicator.textContent = "Live sync unavailable";
          }
        }

        if (liveToggle) {
          liveToggle.addEventListener("click", () => {
            liveEnabled = !liveEnabled;
            liveToggle.textContent = liveEnabled ? "Pause" : "Resume";
            if (liveIndicator) liveIndicator.textContent = liveEnabled ? "Live sync on" : "Live sync paused";
          });
        }
        if (liveRefresh) liveRefresh.addEventListener("click", runLiveRefresh);
        setInterval(() => {
          if (liveEnabled) runLiveRefresh();
        }, 20000);
        runLiveRefresh();

        const severitySelect = document.getElementById("timeline-severity");
        const categorySelect = document.getElementById("timeline-category");
        const searchInput = document.getElementById("timeline-search");
        const timelineRows = Array.from(document.querySelectorAll("#timeline-filter-body tr"));
        const timelineEmpty = document.getElementById("timeline-empty");
        const timelineReset = document.getElementById("timeline-reset");
        const observationCards = Array.from(document.querySelectorAll("[data-observation-item-type][data-observation-item-key]"));
        const observationLedgerList = document.getElementById("observation-ledger-list");
        const observationLedgerEmpty = document.getElementById("observation-ledger-empty");
        const observationLedgerCount = document.getElementById("observation-ledger-count");
        const ledgerFilterAnalyst = document.getElementById("ledger-filter-analyst");
        const ledgerFilterConfidence = document.getElementById("ledger-filter-confidence");
        const ledgerFilterFrom = document.getElementById("ledger-filter-from");
        const ledgerFilterTo = document.getElementById("ledger-filter-to");
        const ledgerLimit = document.getElementById("ledger-limit");
        const ledgerApply = document.getElementById("ledger-apply");
        const ledgerClear = document.getElementById("ledger-clear");
        const ledgerExportJson = document.getElementById("ledger-export-json");
        const ledgerExportCsv = document.getElementById("ledger-export-csv");

        function applyTimelineFilter() {
          const severity = (severitySelect && severitySelect.value || "").toLowerCase();
          const category = (categorySelect && categorySelect.value || "").toLowerCase();
          const query = (searchInput && searchInput.value || "").trim().toLowerCase();
          let visibleCount = 0;
          timelineRows.forEach((row) => {
            const rowSeverity = (row.dataset.severity || "").toLowerCase();
            const rowCategory = (row.dataset.category || "").toLowerCase();
            const rowSearch = (row.dataset.search || "").toLowerCase();
            const matchesSeverity = !severity || rowSeverity === severity;
            const matchesCategory = !category || rowCategory === category;
            const matchesQuery = !query || rowSearch.includes(query);
            const visible = matchesSeverity && matchesCategory && matchesQuery;
            row.style.display = visible ? "" : "none";
            if (visible) visibleCount += 1;
          });
          if (timelineEmpty) timelineEmpty.style.display = visibleCount === 0 ? "" : "none";
        }

        [severitySelect, categorySelect, searchInput].forEach((element) => {
          if (!element) return;
          element.addEventListener("input", applyTimelineFilter);
          element.addEventListener("change", applyTimelineFilter);
        });
        if (timelineReset) {
          timelineReset.addEventListener("click", () => {
            if (severitySelect) severitySelect.value = "";
            if (categorySelect) categorySelect.value = "";
            if (searchInput) searchInput.value = "";
            applyTimelineFilter();
          });
        }

        const observationStore = new Map();
        function observationMapKey(itemType, itemKey) {
          return String(itemType || "") + "::" + String(itemKey || "");
        }

        function ratingLabel(item) {
          const sr = String(item.source_reliability || "").trim();
          const ic = String(item.information_credibility || "").trim();
          return (sr || ic) ? sr + ic : "n/a";
        }

        function ledgerFilters() {
          return {
            analyst: String((ledgerFilterAnalyst && ledgerFilterAnalyst.value) || "").trim().toLowerCase(),
            confidence: String((ledgerFilterConfidence && ledgerFilterConfidence.value) || "").trim().toLowerCase(),
            updated_from: String((ledgerFilterFrom && ledgerFilterFrom.value) || "").trim(),
            updated_to: String((ledgerFilterTo && ledgerFilterTo.value) || "").trim(),
            limit: Math.max(1, parseInt(String((ledgerLimit && ledgerLimit.value) || "12"), 10) || 12)
          };
        }

        function buildQueryString(filters) {
          const params = new URLSearchParams();
          if (filters.analyst) params.set("analyst", filters.analyst);
          if (filters.confidence) params.set("confidence", filters.confidence);
          if (filters.updated_from) params.set("updated_from", filters.updated_from);
          if (filters.updated_to) params.set("updated_to", filters.updated_to);
          const query = params.toString();
          return query ? "?" + query : "";
        }

        function updateLedgerExportLinks(filters) {
          const query = buildQueryString(filters);
          if (ledgerExportJson) ledgerExportJson.href = "/actors/" + encodeURIComponent(actorId) + "/observations/export.json" + query;
          if (ledgerExportCsv) ledgerExportCsv.href = "/actors/" + encodeURIComponent(actorId) + "/observations/export.csv" + query;
        }

        function applyObservationCard(card) {
          const itemType = card.dataset.observationItemType || "";
          const itemKey = card.dataset.observationItemKey || "";
          const data = observationStore.get(observationMapKey(itemType, itemKey)) || {};
          const analystField = card.querySelector(".observation-analyst");
          const confidenceField = card.querySelector(".observation-confidence");
          const sourceReliabilityField = card.querySelector(".observation-source-reliability");
          const infoCredibilityField = card.querySelector(".observation-information-credibility");
          const sourceRefField = card.querySelector(".observation-source-ref");
          const noteField = card.querySelector(".observation-note");
          const metaNode = card.querySelector("[data-observation-meta]");

          if (analystField && data.updated_by) analystField.value = data.updated_by;
          if (confidenceField && data.confidence) confidenceField.value = data.confidence;
          if (sourceReliabilityField && data.source_reliability !== undefined) sourceReliabilityField.value = data.source_reliability;
          if (infoCredibilityField && data.information_credibility !== undefined) infoCredibilityField.value = data.information_credibility;
          if (sourceRefField && data.source_ref) sourceRefField.value = data.source_ref;
          if (noteField && data.note) noteField.value = data.note;
          if (metaNode) {
            const updatedAt = String(data.updated_at || "");
            const updatedBy = String(data.updated_by || "");
            const confidence = String(data.confidence || "moderate");
            const ratingText = ratingLabel(data);
            metaNode.textContent = updatedAt ? "Saved " + updatedAt + " by " + (updatedBy || "analyst") + " | " + confidence + " | rating " + ratingText : "";
          }
        }

        function renderObservationLedger() {
          if (!observationLedgerList || !observationLedgerEmpty) return;
          observationLedgerList.innerHTML = "";
          const filters = ledgerFilters();
          updateLedgerExportLinks(filters);
          const items = Array.from(observationStore.values())
            .filter((item) => {
              const by = String(item.updated_by || "").toLowerCase();
              const conf = String(item.confidence || "").toLowerCase();
              const updated = String(item.updated_at || "").slice(0, 10);
              if (filters.analyst && !by.includes(filters.analyst)) return false;
              if (filters.confidence && conf !== filters.confidence) return false;
              if (filters.updated_from && updated && updated < filters.updated_from) return false;
              if (filters.updated_to && updated && updated > filters.updated_to) return false;
              return true;
            })
            .sort((a, b) => String(b.updated_at || "").localeCompare(String(a.updated_at || "")));
          if (!items.length) {
            observationLedgerEmpty.style.display = "";
            if (observationLedgerCount) observationLedgerCount.textContent = "0 shown";
            return;
          }
          observationLedgerEmpty.style.display = "none";
          const limited = items.slice(0, filters.limit);
          if (observationLedgerCount) observationLedgerCount.textContent = String(limited.length) + " shown";
          limited.forEach((item) => {
            const wrap = document.createElement("div");
            wrap.className = "ledger-item";
            const head = document.createElement("div");
            head.className = "ledger-head";
            const by = document.createElement("span");
            by.textContent = "By " + String(item.updated_by || "analyst");
            const at = document.createElement("span");
            at.textContent = String(item.updated_at || "");
            const conf = document.createElement("span");
            conf.textContent = "Confidence: " + String(item.confidence || "moderate");
            const rating = document.createElement("span");
            rating.textContent = "Rating: " + ratingLabel(item);
            head.append(by, at, conf, rating);
            const body = document.createElement("div");
            body.className = "ledger-body";
            body.textContent = String(item.note || "(no note text)");
            wrap.append(head, body);
            const sourceTitle = String(item.source_title || item.source_name || "");
            const sourceUrl = String(item.source_url || "");
            if (sourceTitle || sourceUrl) {
              const linkWrap = document.createElement("div");
              linkWrap.className = "ledger-link";
              const sourceText = document.createElement(sourceUrl ? "a" : "span");
              if (sourceUrl) {
                sourceText.href = sourceUrl;
                sourceText.target = "_blank";
                sourceText.rel = "noreferrer";
              }
              sourceText.textContent = sourceTitle || sourceUrl;
              linkWrap.appendChild(sourceText);
              wrap.appendChild(linkWrap);
            }
            observationLedgerList.appendChild(wrap);
          });
        }

        async function loadObservations() {
          try {
            const response = await fetch("/actors/" + encodeURIComponent(actorId) + "/observations", { headers: { "Accept": "application/json" } });
            if (!response.ok) return;
            const payload = await response.json();
            const items = Array.isArray(payload.items) ? payload.items : [];
            items.forEach((item) => {
              observationStore.set(observationMapKey(item.item_type, item.item_key), item);
            });
            observationCards.forEach(applyObservationCard);
            renderObservationLedger();
          } catch (error) {
            // Keep page usable even if observation endpoint is unavailable.
          }
        }

        observationCards.forEach((card) => {
          const saveButton = card.querySelector(".observation-save");
          if (!saveButton) return;
          saveButton.addEventListener("click", async () => {
            const itemType = card.dataset.observationItemType || "";
            const itemKey = card.dataset.observationItemKey || "";
            const updatedBy = String((card.querySelector(".observation-analyst") || {}).value || "");
            const confidence = String((card.querySelector(".observation-confidence") || {}).value || "moderate");
            const sourceReliability = String((card.querySelector(".observation-source-reliability") || {}).value || "");
            const informationCredibility = String((card.querySelector(".observation-information-credibility") || {}).value || "");
            const sourceRef = String((card.querySelector(".observation-source-ref") || {}).value || "");
            const note = String((card.querySelector(".observation-note") || {}).value || "");
            const payload = {
              updated_by: updatedBy,
              confidence: confidence,
              source_reliability: sourceReliability,
              information_credibility: informationCredibility,
              source_ref: sourceRef,
              note: note
            };
            try {
              const metaNode = card.querySelector("[data-observation-meta]");
              if (metaNode) metaNode.textContent = "Saving...";
              const response = await fetch(
                "/actors/" + encodeURIComponent(actorId) + "/observations/" + encodeURIComponent(itemType) + "/" + encodeURIComponent(itemKey),
                { method: "POST", headers: { "Content-Type": "application/json", "Accept": "application/json" }, body: JSON.stringify(payload) }
              );
              if (!response.ok) return;
              const data = await response.json();
              observationStore.set(observationMapKey(itemType, itemKey), data);
              observationCards
                .filter((candidate) => (candidate.dataset.observationItemType || "") === itemType && (candidate.dataset.observationItemKey || "") === itemKey)
                .forEach(applyObservationCard);
              renderObservationLedger();
            } catch (error) {
              const metaNode = card.querySelector("[data-observation-meta]");
              if (metaNode) metaNode.textContent = "Save failed. Retry.";
            }
          });
        });

        if (ledgerApply) ledgerApply.addEventListener("click", renderObservationLedger);
        if (ledgerClear) {
          ledgerClear.addEventListener("click", () => {
            if (ledgerFilterAnalyst) ledgerFilterAnalyst.value = "";
            if (ledgerFilterConfidence) ledgerFilterConfidence.value = "";
            if (ledgerFilterFrom) ledgerFilterFrom.value = "";
            if (ledgerFilterTo) ledgerFilterTo.value = "";
            if (ledgerLimit) ledgerLimit.value = "12";
            renderObservationLedger();
          });
        }

        loadObservations();

      })();
    </script>
    {% endif %}
  </body>
</html>
